# Claude Code Agent 系统架构文档

## 🏛️ 系统架构全景

### Claude Code Agent 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                          用户交互层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ CLI接口      │  │ VSCode集成   │  │ Web界面      │          │
│  │ (命令行)     │  │ (插件)       │  │ (浏览器)     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Agent核心调度层                             │
│  ┌──────────────────────────┐  ┌──────────────────────┐        │
│  │ n0主循环引擎              │  │ h2A消息队列           │        │
│  │ (AgentLoop)              │  │ (AsyncQueue)         │        │
│  │ • 任务调度               │  │ • 异步通信            │        │
│  │ • 状态管理               │  │ • 流式处理            │        │
│  │ • 异常处理               │  │ • 背压控制            │        │
│  └──────────────────────────┘  └──────────────────────┘        │
│                   ▼                        ▼                    │
│  ┌──────────────────────────┐  ┌──────────────────────┐        │
│  │ wU会话流生成器            │  │ wU2消息压缩器         │        │
│  │ (StreamGen)              │  │ (Compressor)         │        │
│  │ • 实时响应               │  │ • 智能压缩            │        │
│  │ • 流式输出               │  │ • 上下文优化          │        │
│  └──────────────────────────┘  └──────────────────────┘        │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      工具执行与管理层                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────┐│
│  │ MH1工具引擎  │ │ UH1并发控制  │ │ SubAgent管理 │ │ 权限验证│││
│  │ (ToolEngine) │ │ (Scheduler)  │ │ (TaskAgent)  │ │ (Permis││││
│  │ • 工具发现   │ │ • 并发调配   │ │ • 任务隔离   │ │ • 权限检││││
│  │ • 参数验证   │ │ • 负载均衡   │ │ • 错误恢复   │ │ • 安全审││││
│  │ • 执行调度   │ │ • 资源管理   │ │ • 状态同步   │ │ • 访问控││││
│  └──────────────┘ └──────────────┘ └──────────────┘ └─────────┘│
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        工具生态系统                              │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────┐│
│  │ 文件操作工具 │ │ 搜索发现工具 │ │ 任务管理工具 │ │ 系统执行││││
│  │ • Read/Write │ │ • Glob/Grep  │ │ • Todo系统   │ │ • Bas   ││││
│  │ • Edit/Multi │ │ • 模式匹配   │ │ • 状态跟踪   │ │ • 命令调││││
│  └──────────────┘ └──────────────┘ └──────────────┘ └─────────┘│
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────┐│
│  │ 网络交互工具 │ │ 特殊功能工具 │ │ MCP集成工具  │ │ 开发者工││││
│  │ • WebFetch   │ │ • Plan模式   │ │ • 协议支持   │ │ • 代码诊││││
│  │ • WebSearch  │ │ • 退出计划   │ │ • 服务发现   │ │ • 性能监││││
│  └──────────────┘ └──────────────┘ └──────────────┘ └─────────┘│
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      存储与持久化层                              │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌─────────┐│
│  │ 短期记忆存储 │ │ 中期压缩历史 │ │ 长期持久存储 │ │ 状态缓存││││
│  │ (Messages)   │ │ (Compressed) │ │ (CLAUDE.md)  │ │ (State  ││││
│  │ • 当前会话   │ │ • 历史摘要   │ │ • 用户偏好   │ │ • 工具状││││
│  │ • 上下文队列 │ │ • 关键信息   │ │ • 配置信息   │ │ • 执行历││││
│  │ • 临时缓存   │ │ • 压缩算法   │ │ • 持久化机制 │ │ • 性能指││││
│  └──────────────┘ └──────────────┘ └──────────────┘ └─────────┘│
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 第二章：Agent Loop核心循环机制

### 2.1 主循环执行流程

#### Agent Loop 执行流程图 (n0函数)

```
┌──────────────┐
│   用户输入    │
└──────────────┘
       ▼
┌──────────────────────────────────────────────────────────────┐
│ 消息预处理                                                    │
│ & 上下文检查 │ ◄─── 1. 消息验证与清理                         │
│              │      2. Token使用量评估                        │
│              │      3. 压缩触发检测 (92%)                    │
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────┐        ┌──无需压缩──┐
│ 压缩判断     │        │            │
│ (wU2函数)   │────────┘  需要压缩 ──┐
└──────────────┘                      │
       ▼                              ▼
┌──────────────┐              ┌──────────────────┐
│ 系统提示生成 │              │ 8段式结构化压缩   │
│ (g A0函数)  │              │ AU2算法          │
└──────────────┘              └──────────────────┘
       ▼◄────────────────────────────┘
┌──────────────────────────────────────────────────────────────┐
│ 会话流生成                                                    │
│ (wU函数)    │ ◄─── 1. 模型配置与选择                         │
│              │      2. 流式响应管理                          │
│              │      3. 中断信号处理                          │
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────────────────────────────────────────────────────┐
│ 对话管理处理                                                  │
│ (nE2函数)   │ ◄─── 1. LLM API调用                           │
│              │      2. 模型降级处理                          │
│              │      3. 错误恢复机制                          │
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────────────────────────────────────────────────────┐
│ 工具调用     │                                               │
│ 检测与解析   │ ────── 无工具调用 ──┐                          │
│              │                      │                         │
│              │      有工具调用      │                         │
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────────────────────────────────────────────────────┐
│ MH1工具执行  │                                               │
│ 引擎启动    │ ◄─── 1. 工具发现与验证                         │
│              │      2. 权限检查与门控                        │
│              │      3. 并发控制调度                          │
│              │      4. 执行结果处理                          │
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────────────────────────────────────────────────────┐
│ 结果整合     │                                               │
│ & 状态更新  │ ◄─────────────────────────────────────────────│
└──────────────────────────────────────────────────────────────┘
       ▼
┌──────────────┐        ┌──继续循环──┐
│ 循环判断     │        │            │
│ (退出条件)   │────────┘  结束循环 ──┐
└──────────────┘                      │
       ▼                              ▼
┌──────────────┐
│ 响应输出     │
│ & 会话结束  │
└──────────────┘
       ▲
       │───────────────────────────────┘
```

### 2.2 n0主循环函数技术实现

```javascript
// n0函数：Agent主循环Orchestrator
async function* agentMainLoop(messages, systemPrompts, maxThinkingTokens,
                              config, abortSignal, executionContext,
                              turnState, fallbackModel, additionalOptions) {
  
  // 阶段1：循环初始化
  yield { type: "stream_request_start" };
  
  let originalMessages = messages;
  let currentTurnState = turnState;
  
  // 阶段2：消息压缩检查 (wU2函数调用)
  let { messages: processedMessages, wasCompacted } =
    await messageCompactor(messages, executionContext);
  
  if (wasCompacted) {
```

---

## 🧠 第三章：记忆与上下文管理机制

### 3.1 三层记忆架构

#### 记忆与上下文管理系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        短期记忆层                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    当前会话上下文                         │  │
│  │    messages[] - 实时消息数组                             │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────┐│  │
│  │  │ User       │ │ Assistant  │ │ Tool       │ │ System ││  │
│  │  │ Message    │ │ Message    │ │ Result     │ │ Prompt ││  │
│  │  └────────────┘ └────────────┘ └────────────┘ └────────┘│  │
│  │                                                          │  │
│  │  特征: O(1)查找, 实时访问, 自动Token统计                │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                        92%阈值触发                              │
│                              ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    中期记忆层                            │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │         8段式结构化压缩 (AU2算法)                   │  │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │  │  │
│  │  │  │ 背景上下文 │  │ 关键决策   │  │ 工具使用   │    │  │  │
│  │  │  │ Context    │  │ Decisions  │  │ Tool Usage │    │  │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘    │  │  │
│  │  │                                                    │  │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │  │  │
│  │  │  │ 用户意图   │  │ 执行结果   │  │ 错误处理   │    │  │  │
│  │  │  │ User Intent│  │ Results    │  │ Error Cases│    │  │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘    │  │  │
│  │  │                                                    │  │  │
│  │  │  ┌────────────┐  ┌────────────┐                    │  │  │
│  │  │  │ 未解决问题 │  │ 后续计划   │                    │  │  │
│  │  │  │ Open Issues│  │ Future Plans│                   │  │  │
│  │  │  └────────────┘  └────────────┘                    │  │  │
│  │  │                                                    │  │  │
│  │  │  特征: 智能压缩, 上下文连续, 大幅节省Token          │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│                        持久化存储                               │
│                              ▼                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    长期记忆层                            │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │                 CLAUDE.md系统                      │  │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │  │  │
│  │  │  │ 项目上下文 │  │ 用户偏好   │  │ 工作流程   │    │  │  │
│  │  │  │ Project Info│ │ Preferences│  │ Workflows  │    │  │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘    │  │  │
│  │  │                                                    │  │  │
│  │  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │  │  │
│  │  │  │ 代码风格   │  │ 开发环境   │  │ 安全配置   │    │  │  │
│  │  │  │ Code Style │  │ Environment│  │ Security   │    │  │  │
│  │  │  └────────────┘  └────────────┘  └────────────┘    │  │  │
│  │  │                                                    │  │  │
│  │  │  特征: 跨会话恢复, 用户定制, 项目持续记忆           │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3.2 智能压缩算法实现

### 3.2.1 压缩触发机制

```javascript
// wU2函数：消息压缩核心实现
async function messageCompactor(messages, executionContext) {
  // 步骤1: Token使用量评估
  const currentTokenUsage = VE(messages);  // 获取当前Token使用量
  const { isAboveAutoCompactThreshold } = m11(currentTokenUsage, h11);
  
  // 步骤2: 压缩判断
  if (!h11() || !isAboveAutoCompactThreshold) {
    return { messages: messages, wasCompacted: false };
  }
  
  // 步骤3: 压缩执行
  try {
    const compressionResult = await executeCompression(messages, executionContext);
    
    if (compressionResult.success) {
      // 记录压缩指标
      recordCompressionMetrics({
        originalCount: messages.length,
        compressedCount: compressionResult.compressedMessages.length,
        tokenSaved: currentTokenUsage - compressionResult.newTokenCount,
        compressionRatio: compressionResult.compressionRatio
      });
      
      return {
        messages: compressionResult.compressedMessages,
        wasCompacted: true,
        compressionSummary: compressionResult.summary
      };
    }
  } catch (error) {
    // 压缩失败, 返回原始消息
    recordCompressionError(error);
    return { messages: messages, wasCompacted: false };
  }
  
  return { messages: messages, wasCompacted: false };
}
```

### 3.2.2 8段式结构化压缩 (AU2算法)

```javascript
// AU2函数：8段式压缩提示生成函数
function generateCompressionPrompt(messages, context) {
  return `请按照以下8个结构化维度对话历史:

## 1. 背景上下文 (Background Context)
- 项目类型和技术栈
- 当前工作目标和环境
- 用户的总体目标

## 2. 关键决策 (Key Decisions)
- 重要的技术选择和原因
- 架构决策和设计考虑
- 问题解决方案的选择

## 3. 工具使用记录 (Tool Usage Log)
- 主要使用的工具类型
- 文件操作历史
- 命令执行结果

## 4. 用户意图演进 (User Intent Evolution)
- 需求的支化过程
- 优先级调整
- 新增功能需求

## 5. 执行结果汇总 (Execution Results)
- 成功完成的任务
- 生成的代码和文件
- 验证和测试结果

## 6. 错误与解决 (Errors and Solutions)
- 遇到的问题类型
- 错误解决方法
- 经验教训

## 7. 未解决问题 (Open Issues)
- 当前待解决的挑战
- 已知但未处理的未来
- 需要后续关注的事项

## 8. 后续计划 (Future Plans)
- 下一步行动计划
- 长期目标和规划
- 用户表达的期待

请将以上信息压缩到{CU2}个Token以内, 保持技术准确性和上下文连续性。`;
}
```

---

## 3.3 上下文注入与恢复机制

#### 文件内容注入与恢复流程

```
    用户提及文件                    系统检测到文件引用
         │                                │
         ▼                                ▼
┌─────────────────┐              ┌──────────────────┐
│   文件路径      │              │   自动检测       │
│   解析验证      │              │   相关文件       │
└─────────────────┘              └──────────────────┘
         │                                │
         ▼                                ▼
┌─────────────────────────────────────────────────────┐
│                   安全检查                          │
│   • 路径验证                                        │
│   • 权限检查                                        │
│   • 文件存在                                        │
└─────────────────────────────────────────────────────┘
         │                                │
         └────────────────┬───────────────┘
                          ▼
┌─────────────────────────────────────────────────────┐
│                   智能推荐                          │
│   • 依赖分析                                        │
│   • 关联度计算                                      │
│   • 优先级排序                                      │
└─────────────────────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────┐
│                   容量控制                          │
│   • 最大20文件                                      │
│   • 每个8K Token                                    │
│   • 总计32K限制                                     │
└─────────────────────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────┐
│                   内容注入                          │
│   • 格式化处理                                      │
│   • 语法高亮                                        │
│   • 行号显示                                        │
└─────────────────────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────┐
│                 上下文更新                          │
│               并返回给用户                          │
└─────────────────────────────────────────────────────┘
```

---

## 🛠️ 第四章：工具系统实现与协同机制

### 4.1 工具执行引擎架构

#### 工具执行引擎 (MH1) 完整流水线

```
用户工具调用请求
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段1:                                                         │
│ 工具发现      │ ◄──── • 工具名称解析                           │
│ & 验证       │       • 工具注册表查找                          │
│              │       • 可用性检查                              │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段2:                                                         │
│ 输入验证      │ ◄──── • Zod Schema验证                         │
│ (Schema)     │       • 参数类型检查                            │
│              │       • 必填参数验证                            │
│              │       • 格式化错误消息                          │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段3:                                                         │
│ 权限检查      │ ◄──── • checkPermissions调用                   │
│ & 门控       │       • allow/deny/ask三种行为                  │
│              │       • Hook机制支持                            │
│              │       • 安全策略应用                            │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段4:                                                         │
│ 取消检查      │ ◄──── • AbortController信号                    │
│ (Abort)      │       • 用户中断处理                            │
│              │       • 超时控制                                │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段5:                                                         │
│ 工具执行      │ ◄──── • pW5具体执行函数                        │
│ (Execute)    │       • 异步生成式处理                          │
│              │       • 流式结果输出                            │
│              │       • 错误捕获与处理                          │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────────────────────────────────────────────────────┐
│ 阶段6:                                                         │
│ 结果格式化    │ ◄──── • mapToolResultToToolResultBlock         │
│ & 清理       │       • 结果标准化                              │
│              │       • 状态清理                                │
│              │       • 分析事件记录                            │
└────────────────────────────────────────────────────────────────┘
       ▼
┌────────────────┐
│   输出结果      │
│  到Agent Loop  │
└────────────────┘
```

---

## 4.4 SubAgent架构与Task工具

#### SubAgent架构与Task工具机制

```
主Agent (n0循环)
       │
       │  Task工具调用
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  Task工具                                                       │
│  cX="Task"    │ ◄────── • 用户任务描述解析                      │
│               │         • SubAgent环境准备                      │
│               │         • 工具集合配置                          │
└─────────────────────────────────────────────────────────────────┘
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  I2A函数                                                        │
│  SubAgent     │ ◄────── • 新的Agent实例创建                     │
│  实例化       │         • 独立执行环境                          │
│               │         • 隔离权限管理                          │
│               │         • 专用工具子集                          │
└─────────────────────────────────────────────────────────────────┘
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  CN5 Schema                                                     │
│  输入验证     │ ◄────── description: 任务简短描述(3-5词)        │
│               │         prompt: 详细任务执行指令                │
└─────────────────────────────────────────────────────────────────┘
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  SubAgent                                                       │
│  独立执行     │ ◄────── • 独立的n0循环实例                      │
│  Environment  │         • 专用消息队列                          │
│               │         • 隔离的工具权限                        │
│               │         • 独立错误处理                          │
└─────────────────────────────────────────────────────────────────┘
       ▼
┌─────────────────────────────────────────────────────────────────┐
│  执行结果                                                       │
│  返回主Agent │ ◄────── • 单一消息返回机制                      │
│               │         • 无状态通信模式                        │
│               │         • 结果摘要生成                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 📝 第五章：长期规划机制分析

### 5.1 Todo系统技术实现

#### Todo系统完整架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Todo工具对象层                           │
│  ┌──────────────────────────┐  ┌──────────────────────────┐    │
│  │  TodoWrite               │  │  TodoRead                │    │
│  │  (y6对象)                │  │  (oN对象)                │    │
│  │                          │  │                          │    │
│  │  • 任务创建              │  │  • 任务查询              │    │
│  │  • 状态更新              │  │  • 状态展示              │    │
│  │  • 优先级设置            │  │  • 进度跟踪              │    │
│  └──────────────────────────┘  └──────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据管理层                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  YJ1排序算法引擎                          │  │
│  │                                                           │  │
│  │  状态优先级: pending(0) → in_progress(1) → completed(2)  │  │
│  │  重要性排序: high(0) → medium(1) → low(2)                │  │
│  │                                                           │  │
│  │  排序逻辑:                                                │  │
│  │  1. 按状态分组 (进行中 > 待处理 > 已完成)                │  │
│  │  2. 组内按优先级排序 (高 > 中 > 低)                      │  │
│  │  3. 相同优先级按创建时间排序                             │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      存储持久化层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  React       │  │  会话状态    │  │  本地缓存    │          │
│  │  状态管理    │  │  存储        │  │  系统        │          │
│  │              │  │              │  │              │          │
│  │  • useState  │  │  • 轮次隔离  │  │  • 浏览器缓存│          │
│  │  • useEffect │  │  • 状态同步  │  │  • 会话恢复  │          │
│  │  • 组件更新  │  │  • 数据一致性│  │  • 离线支持  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 👥 第六章：复杂多轮对话场景模拟分析

### 6.1 场景一：大型项目代码重构 (23轮对话)

#### 大型项目代码重构场景 Agent 执行流程分析

**轮次 1-3: 项目理解阶段**

```
用户: "帮我重构这个React项目，提升性能"
├── Agent: 启动LS工具扫描项目结构
├── Agent: 启动Glob查找React组件文件
├── Agent: 启动Read工具读取package.json分析依赖
└── TodoWrite: 创建["分析项目结构","性能问题诊断","重构方案制定"]
```

**轮次 4-8: 问题诊断阶段**

```
├── Agent: 启动Task SubAgent并发分析5个核心组件
│   ├── SubAgent-1: 分析App.js性能瓶颈
│   ├── SubAgent-2: 分析状态管理结构
│   ├── SubAgent-3: 检查重复代码模式
│   ├── SubAgent-4: Bundle size分析
│   └── SubAgent-5: 依赖关系梳理
├── 并发控制: UH1调度器限制最大5个并发SubAgent
└── TodoWrite: 更新诊断结果到任务列表
```

**轮次 9-15: 重构执行阶段**

```
├── 上下文压缩: wU2触发(使用率达到94%)
│   └── AU2算法压缩前9轮对话为8段结构化摘要
├── Agent: 启动MultiEdit批量重构组件
│   ├── 提取共用Hook逻辑
│   ├── 实现React.memo优化
│   ├── 代码分割和懒加载
│   └── 状态管理重构
├── Bash: 运行性能测试验证改进效果
└── System-reminder注入: 提醒保持代码风格一致性
```

**轮次 16-23: 验证与优化阶段**

```
├── Agent: Bash执行自动化测试套件
├── WebFetch: 获取最新性能优化最佳实践
├── 性能对比分析: 重构前后Bundle size减少35%
├── TodoWrite: 标记重构任务完成，创建后续优化计划
├── 第二次压缩: 由于对话较次过多再次触发AU2压缩
└── 最终输出: 生成重构报告和性能改进文档
```

---

## 🔒 第七章：安全防护与边界处理机制

### 7.1 6层安全防护架构

#### Claude Code 6层安全防护体系

```
┌─────────────────────────────────────────────────────────────────┐
│                      第1层: 输入验证层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Zod Schema   │  │ 参数类型     │  │ 格式验证     │          │
│  │ 严格验证     │  │ 强制检查     │  │ 边界约束     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第2层: 权限控制层                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  权限验证三元组                           │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                │  │
│  │  │ Allow    │  │ Deny     │  │ Ask      │                │  │
│  │  │ 直接执行 │  │ 拒绝执行 │  │ 用户确认 │                │  │
│  │  └──────────┘  └──────────┘  └──────────┘                │  │
│  │                                                           │  │
│  │                       ▼                                   │  │
│  │               Hook机制统过通道                            │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第3层: 沙箱隔离层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ Bash沙箱     │  │ 文件系统     │  │ 网络访问     │          │
│  │ sandbox=true │  │ 写入限制     │  │ 域名白名单   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第4层: 执行监控层                          │
│  ┌──────────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ AbortController  │  │ 超时控制     │  │ 资源限制     │      │
│  │ 中断信号         │  │ 防止卡死     │  │ 内存/CPU     │      │
│  └──────────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第5层: 错误恢复层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 异常捕获     │  │ 错误分类     │  │ 自动重试     │          │
│  │ try/catch    │  │ 详细日志     │  │ 降级处理     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      第6层: 审计记录层                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ 操作日志     │  │ 安全事件     │  │ 合规报告     │          │
│  │ 完整链路     │  │ 实时告警     │  │ 审期审计     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7.3 并发安全保障

#### 并发执行安全控制机制 (UH1调度器)

```
┌─────────────────────────────────────────────────────────────────┐
│                      工具并发安全分类                           │
│                                                                 │
│  ┌─────────────────────────────┐  ┌─────────────────────────┐  │
│  │     并发安全工具             │  │   非并发安全工具         │  │
│  │                             │  │                         │  │
│  │  • Read                     │  │  • Write                │  │
│  │  • LS                       │  │  • Edit                 │  │
│  │  • Glob                     │  │  • MultiEdit            │  │
│  │  • Grep                     │  │  • Bash                 │  │
│  │  • WebFetch                 │  │  • TodoWrite            │  │
│  │  • TodoRead                 │  │                         │  │
│  │  • Task                     │  │                         │  │
│  │                             │  │                         │  │
│  │  最大并发: 10               │  │  串行执行: 1            │  │
│  └─────────────────────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                          ▼                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                   UH1调度算法核心逻辑                           │
│                                                                 │
│  1. 并发安全工具可以同时执行 (最大10个)                         │
│  2. 非并发安全工具必须串行执行                                  │
│  3. 混合场景下优先执行并发安全工具                              │
│  4. 使用Promise.race实现抢占式调度                              │
│  5. 动态调整并发度基于系统负载                                  │
│                                                                 │
│  并发冲突检测算法:                                              │
│  ├── 文件写入冲突检测 (Write/Edit工具)                          │
│  ├── 系统资源竞争检测 (Bash工具)                                │
│  ├── 状态修改冲突检测 (TodoWrite工具)                           │
│  └── 网络请求频率限制 (WebFetch/WebSearch工具)                  │
└─────────────────────────────────────────────────────────────────┘
```

---

**文档生成时间**: 2025年2月

**版本**: v1.0

**作者**: Claude Code Agent 系统架构分析
